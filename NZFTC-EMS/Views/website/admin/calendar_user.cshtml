@using NZFTC_EMS.Data.Entities
@model NZFTC_EMS.Models.ViewModels.CalendarVm

@{
    Layout = ViewData["Layout"]?.ToString();
    ViewData["Title"] = "Calendar";

    int month = Model.CurrentMonth;
    int year = Model.CurrentYear;

    var firstDayOfMonth = new DateTime(year, month, 1);
    int daysInMonth = DateTime.DaysInMonth(year, month);
    int startOffset = (int)firstDayOfMonth.DayOfWeek;

    int totalCells = (startOffset + daysInMonth <= 35) ? 35 : 42;

    int prevMonth = month == 1 ? 12 : month - 1;
    int prevYear = month == 1 ? year - 1 : year;

    int nextMonth = month == 12 ? 1 : month + 1;
    int nextYear = month == 12 ? year + 1 : year;
}

<style>
    .calendar-wrapper {
        max-width: 1100px;
        margin: 0 auto;
    }

    .calendar-card {
        background-color: #ffffff;
        border-radius: 16px;
        border: 1px solid #e1e1e1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        overflow: hidden;
    }

    .calendar-header-title {
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 700;
    }

    .day-number {
        position: absolute;
        top: 6px;
        right: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .calendar-day,
    .calendar-empty {
        position: relative;
        padding: 0.4rem;
        height: 110px;
        vertical-align: top;
        background-color: #ffffff;
    }

    .calendar-empty {
        background-color: #f8f9fa;
    }

    .calendar-weekend {
        background-color: #fafafa;
    }

    .calendar-today {
        box-shadow: inset 0 0 0 2px #0d6efd;
        background-color: #e7f1ff;
    }

    .calendar-event {
        font-size: 0.7rem;
    }

    .badge-public {
        background-color: #d9534f; /* red-ish */
    }

    .badge-meeting {
        background-color: #0dcaf0; /* info */
    }

    .badge-leave {
        background-color: #ffc107; /* warning */
        color: #212529;
    }

    .badge-other {
        background-color: #6c757d;
    }

    @@media (max-width: 768px) {
        .calendar-day,
        .calendar-empty {
            height: 80px;
            padding: 0.25rem;
        }

        .day-number {
            font-size: 0.75rem;
        }

        .calendar-header-title {
            font-size: 1.1rem;
        }

        .table thead th {
            font-size: 0.7rem;
            padding: 0.25rem;
        }
    }
</style>

<div class="container py-4 calendar-wrapper">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0 fw-bold">Admin Calendar</h3>

        <!-- Phase 3: hook to Create action -->
        <button class="btn btn-primary btn-sm" disabled>
            + Add Event (Create coming later)
        </button>
    </div>

    <div class="calendar-card p-3">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a asp-controller="calendar"
               asp-action="UserCalendar"
               asp-route-month="@prevMonth"
               asp-route-year="@prevYear"
               class="btn btn-outline-secondary btn-sm">
                &laquo; Prev
            </a>

            <h4 class="calendar-header-title m-0">
                @firstDayOfMonth.ToString("MMMM").ToUpper() @year
            </h4>

            <a asp-controller="calendar"
               asp-action="UserCalendar"
               asp-route-month="@nextMonth"
               asp-route-year="@nextYear"
               class="btn btn-outline-secondary btn-sm">
                Next &raquo;
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle mb-0"
                   style="table-layout: fixed; width: 100%;">
                <thead class="table-light">
                    <tr class="fw-bold text-uppercase small">
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int day = 1;

                        for (int i = 0; i < totalCells; i++)
                        {
                            if (i % 7 == 0)
                            {
                                @:<tr>
                            }

                            if (i < startOffset || day > daysInMonth)
                            {
                                <td class="calendar-empty"></td>
                            }
                            else
                            {
                                var date = new DateTime(year, month, day);
                                bool isToday = date.Date == DateTime.Today.Date;
                                bool isWeekend = date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;

                                var tdClasses = "calendar-day";
                                if (isWeekend) tdClasses += " calendar-weekend";
                                if (isToday) tdClasses += " calendar-today";

                                var eventsForDay = Model.Events
                                    .Where(e => e.Start.Date == date.Date)
                                    .OrderBy(e => e.EventType)
                                    .ToList();

                                <td class="@tdClasses">
                                    <div class="day-number">@day</div>

                                    @foreach (var ev in eventsForDay)
                                    {
                                        var badgeClass = "badge-other";

                                        if (ev.EventType == CalendarEventType.PublicHoliday)
                                            badgeClass = "badge-public";
                                        else if (ev.EventType == CalendarEventType.Meeting)
                                            badgeClass = "badge-meeting";
                                        else if (ev.EventType == CalendarEventType.AnnualLeave)
                                            badgeClass = "badge-leave";

                                        <span class="badge calendar-event d-block mb-1 text-truncate @badgeClass"
                                              title="@($"{ev.Title} | {ev.Start:HH\\:mm}-{ev.End:HH\\:mm}")">
                                            @ev.Title
                                        </span>
                                    }
                                </td>;

                                day++;
                            }

                            if (i % 7 == 6)
                            {
                                @:</tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <h6 class="fw-semibold">Legend</h6>
        <div class="d-flex flex-wrap gap-2 small">
            <span class="badge badge-public">Public Holiday</span>
            <span class="badge badge-meeting">Meeting</span>
            <span class="badge badge-leave">Annual Leave</span>
            <span class="badge badge-other">Other</span>
        </div>
    </div>
</div>



