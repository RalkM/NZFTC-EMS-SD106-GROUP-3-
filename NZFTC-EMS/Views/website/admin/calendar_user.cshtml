@using System.Linq
@using NZFTC_EMS.Data.Entities
@model NZFTC_EMS.Models.ViewModels.CalendarVm

@{
    Layout = ViewData["Layout"]?.ToString();
    ViewData["Title"] = "Calendar";

    int month = Model.CurrentMonth;
    int year = Model.CurrentYear;

    var firstDayOfMonth = new DateTime(year, month, 1);
    int daysInMonth = DateTime.DaysInMonth(year, month);
    int startOffset = (int)firstDayOfMonth.DayOfWeek;

    int totalCells = (startOffset + daysInMonth <= 35) ? 35 : 42;
    int rows = totalCells / 7;

    int prevMonth = month == 1 ? 12 : month - 1;
    int prevYear = month == 1 ? year - 1 : year;

    int nextMonth = month == 12 ? 1 : month + 1;
    int nextYear = month == 12 ? year + 1 : year;
}

<link rel="stylesheet" href="~/css/calendar.css" asp-append-version="true" />


<div class="container py-4 calendar-wrapper">

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0 fw-bold">Calendar</h3>

        <a asp-controller="calendar"
           asp-action="AdminCreate"
           class="btn btn-primary btn-sm">
            + Add Event
        </a>
    </div>

    <div class="calendar-card p-3">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a asp-controller="calendar"
               asp-action="UserCalendar"
               asp-route-month="@prevMonth"
               asp-route-year="@prevYear"
               class="btn btn-outline-primary btn-sm">
                &laquo; Prev
            </a>

            <h4 class="calendar-header-title m-0">
                @firstDayOfMonth.ToString("MMMM").ToUpper() @year
            </h4>

            <a asp-controller="calendar"
               asp-action="UserCalendar"
               asp-route-month="@nextMonth"
               asp-route-year="@nextYear"
               c class="btn btn-outline-primary btn-sm">
                Next &raquo;
            </a>
        </div>

        <div>
            <table class="table table-bordered text-center align-middle mb-0"
                   style="table-layout: fixed; width: 100%;">
                <thead class="table-light">
                    <tr class="fw-bold text-uppercase small">
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int day = 1;

                        for (int row = 0; row < rows; row++)
                        {
                            <tr>
                                @for (int col = 0; col < 7; col++)
                                {
                                    int cellIndex = row * 7 + col;

                                    if (cellIndex < startOffset || day > daysInMonth)
                                    {
                                        <td class="calendar-empty"></td>
                                    }
                                    else
                                    {
                                        var date = new DateTime(year, month, day);

                                        var eventsForDay = Model.Events
                                        .Where(e => e.Start.Date == date.Date)
                                        .OrderBy(e => e.EventType)
                                        .ToList();

                                        var holidaysForDay = Model.Holidays
                                        .Where(h => h.HolidayDate.Date == date.Date)
                                        .ToList();

                                        bool isToday = date.Date == DateTime.Today.Date;
                                        bool isWeekend = date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;

                                        var tdClasses = "calendar-day";
                                        if (isWeekend) tdClasses += " calendar-weekend";
                                        if (isToday) tdClasses += " calendar-today";

                                        <td class="@tdClasses">
                                            <!-- Day number: click to ADD event -->
                                            <a asp-controller="calendar"
                                               asp-action="AdminCreate"
                                               asp-route-date="@date.ToString("yyyy-MM-ddTHH:mm")"
                                               class="day-number text-decoration-none text-dark">
                                                @day
                                            </a>

                                            <div class="calendar-events">
                                                @foreach (var ev in eventsForDay)
                                                {
                                                    var badgeClass = "badge-other";

                                                    if (ev.EventType == CalendarEventType.PublicHoliday)
                                                        badgeClass = "badge-holiday";
                                                    else if (ev.EventType == CalendarEventType.Meeting)
                                                        badgeClass = "badge-meeting";
                                                    else if (ev.EventType == CalendarEventType.AnnualLeave)
                                                        badgeClass = "badge-leave";

                                                    <a asp-controller="calendar"
                                                       asp-action="AdminEdit"
                                                       asp-route-id="@ev.Id"
                                                       class="badge calendar-event @badgeClass d-block mb-1 text-truncate text-decoration-none"
                                                       title="@($"{ev.Title} | {ev.Start:HH\\:mm}-{ev.End:HH\\:mm}")">
                                                        @ev.Title
                                                    </a>
                                                }

                                                @foreach (var h in holidaysForDay)
                                                {
                                                    <span class="badge calendar-event d-block mb-1 text-truncate badge-holiday"
                                                          title="@h.Name">
                                                        @h.Name
                                                    </span>
                                                }
                                            </div>
                                        </td>

                                        day++;
                                    }
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <h6 class="fw-semibold">Legend</h6>
        <div class="d-flex flex-wrap gap-2 small">
            <span class="badge calendar-event badge-holiday">Public Holiday</span>
            <span class="badge calendar-event badge-meeting">Meeting</span>
            <span class="badge calendar-event badge-leave">Annual Leave</span>
            <span class="badge calendar-event badge-other">Other / To-do</span>
            <span class="badge badge-today">Today</span>
        </div>
    </div>
</div>
