@using NZFTC_EMS.ViewModels
@model IEnumerable<SupportTicketRowVm>
@using System.Linq

@{
    var hasAny = Model?.Any() ?? false;
    var rows = Model ?? Enumerable.Empty<SupportTicketRowVm>();
    Layout = ViewData["Layout"]?.ToString();
    ViewData["Title"] = "Support Management";

    var q = Context.Request.Query["q"].ToString();
    var status = Context.Request.Query["status"].ToString();
    var priority = Context.Request.Query["priority"].ToString();
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0 fw-bold">Support Management</h3>
        <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#createTicket">
            <i class="fa-solid fa-plus"></i> New Ticket
        </button>
    </div>

    <!-- Filters -->
    <form method="get" asp-controller="Support_Management" asp-action="Index" class="row g-2 mb-4 align-items-end">
        <div class="col-md-4">
            <label class="form-label">Search</label>
            <input name="q" class="form-control" placeholder="Subject or message…" value="@q" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
                <option value="">Any</option>
                @foreach (var s in new[] { "Open","InProgress","Resolved","Closed" })
                {
                    <option value="@s" selected="@(s == status)">
                        @s
                    </option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Priority</label>
            <select name="priority" class="form-select">
                <option value="">Any</option>
                @foreach (var p in new[] { "Low","Medium","High","Urgent" })
                {
                    <option value="@p" selected="@(p == priority)">
                        @p
                    </option>
                }
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-primary w-100">Filter</button>
        </div>
    </form>

    <!-- Create Ticket -->
    <div id="createTicket" class="collapse mb-4">
        <form asp-controller="Support_Management" asp-action="Create" method="post" class="p-4 bg-light rounded shadow-sm">
            @Html.AntiForgeryToken()
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Subject</label>
                    <input name="Subject" class="form-control" required maxlength="120" />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Priority</label>
                    <select name="Priority" class="form-select">
                        <option>Low</option>
                        <option selected>Medium</option>
                        <option>High</option>
                        <option>Urgent</option>
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label fw-bold">Message</label>
                    <textarea name="Message" class="form-control" rows="4" required maxlength="4000"></textarea>
                </div>
                <div class="col-12 text-end">
                    <button class="btn btn-success">Create Ticket</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Tickets Table -->
    <div class="table-responsive shadow-sm">
        <table class="table table-bordered align-middle">
            <thead class="table-primary">
                <tr class="text-center">
                    <th style="width: 6rem;">ID</th>
                    <th>Subject</th>
                    <th>Preview</th>
                    <th style="width: 8rem;">Status</th>
                    <th style="width: 8rem;">Priority</th>
                    <th style="width: 12rem;">Created</th>
                    <th style="width: 14rem;">Actions</th>
                </tr>
            </thead>
            <tbody>
            @if (!(Model?.Any() ?? false))
            {
                <tr><td colspan="7" class="text-center text-muted">No tickets found.</td></tr>
            }
            else
            {
                @foreach (var t in (Model ?? Enumerable.Empty<SupportTicketRowVm>()))
                {
                    <tr>
                        <td class="text-center fw-semibold">@t.Id</td>
                        <td class="fw-semibold">@t.Subject</td>
                        <td>@t.Preview</td>
                        <td class="text-center">
                            <span class="badge @StatusBadgeClass(t.Status)">@t.Status</span>
                        </td>
                        <td class="text-center">
                            <span class="badge @PriorityBadgeClass(t.Priority)">@t.Priority</span>
                        </td>
                        <td class="text-nowrap text-center">@t.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</td>
                        <td class="text-center">
                            <div class="d-flex gap-2 justify-content-center">
                                <form asp-controller="Support_Management" asp-action="SetStatus" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <input type="hidden" name="status" value="Resolved" />
                                    <button class="btn btn-sm btn-outline-success">Resolve</button>
                                </form>
                                <form asp-controller="Support_Management" asp-action="SetStatus" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <input type="hidden" name="status" value="Closed" />
                                    <button class="btn btn-sm btn-outline-secondary">Close</button>
                                </form>
                                <!-- Quick reply (simple demo) -->
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#reply-@t.Id">Reply</button>
                            </div>

                            <div id="reply-@t.Id" class="collapse mt-2 text-start">
                                <form asp-controller="Support_Management" asp-action="Reply" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@t.Id" />
                                    <div class="input-group">
                                        <input name="body" class="form-control" placeholder="Type a quick reply…" maxlength="4000" required />
                                        <button class="btn btn-primary">Send</button>
                                    </div>
                                </form>
                            </div>
                        </td>
                    </tr>
                }
            }
            </tbody>
        </table>
    </div>
</div>

<script src="https://kit.fontawesome.com/5c09730e7a.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

@functions{
    // Simple helpers for badge styling; tweak to your theme
    private string StatusBadgeClass(string status) => status switch
    {
        "Open" => "text-bg-warning",
        "InProgress" => "text-bg-info",
        "Resolved" => "text-bg-success",
        "Closed" => "text-bg-secondary",
        _ => "text-bg-light"
    };

    private string PriorityBadgeClass(string priority) => priority switch
    {
        "Low" => "text-bg-secondary",
        "Medium" => "text-bg-primary",
        "High" => "text-bg-warning",
        "Urgent" => "text-bg-danger",
        _ => "text-bg-light"
    };
}
