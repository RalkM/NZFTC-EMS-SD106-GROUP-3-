@using System.Linq
@using NZFTC_EMS.Data.Entities
@model NZFTC_EMS.Models.ViewModels.CalendarVm

@{
    Layout = ViewData["Layout"]?.ToString();
    ViewData["Title"] = "Calendar";

    int month = Model.CurrentMonth;
    int year = Model.CurrentYear;

    var firstDayOfMonth = new DateTime(year, month, 1);
    int daysInMonth = DateTime.DaysInMonth(year, month);
    int startOffset = (int)firstDayOfMonth.DayOfWeek;

    int totalCells = (startOffset + daysInMonth <= 35) ? 35 : 42;
    int rows = totalCells / 7;

    int prevMonth = month == 1 ? 12 : month - 1;
    int prevYear = month == 1 ? year - 1 : year;

    int nextMonth = month == 12 ? 1 : month + 1;
    int nextYear = month == 12 ? year + 1 : year;
}

<link rel="stylesheet" href="~/css/calendar.css" asp-append-version="true" />

<style>
    .calendar-wrapper {
        max-width: 1100px;
        margin: 0 auto;
    }

    .calendar-card {
        background-color: #ffffff;
        border-radius: 16px;
        border: 1px solid #e1e1e1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        overflow: hidden;
    }

    .calendar-header-title {
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 700;
    }

    /* Day number pill (clickable) */
    .day-number {
        position: absolute;
        top: 6px;
        right: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        opacity: 0.9;
        border-radius: 999px;
        padding: 2px 6px;
        cursor: pointer;
        transition: background-color 0.15s ease, color 0.15s ease;
    }

    .calendar-day,
    .calendar-empty {
        position: relative;
        padding: 0.4rem;
        height: 110px;
        vertical-align: top;
        background-color: #ffffff;
        transition: background-color 0.15s ease, box-shadow 0.15s ease;
    }

    .calendar-empty {
        background-color: #f8f9fa;
    }

    /* push events down a bit under the day number */
    .calendar-events {
        margin-top: 1.6rem;
    }

    /* Hover effect like admin */
    .calendar-day:hover {
        background-color: #f5f7fb;
        box-shadow: inset 0 0 0 1px #d0d7ff;
    }

        .calendar-day:hover .day-number {
            background-color: #0d6efd;
            color: #ffffff;
        }

    /* Weekend subtle shading */
    .calendar-weekend {
        background-color: #fafafa;
    }

    /* Today's cell highlight (same as admin) */
    .calendar-today {
        box-shadow: inset 0 0 0 2px #6aa7ff;
        background-color: #e7f1ff;
    }

        .calendar-today .day-number {
            background-color: #6aa7ff;
            color: #ffffff;
        }

    .calendar-event {
        font-size: 0.7rem;
    }

    .badge-public {
        background-color: #20c997;
        color: #ffffff;
    }

    .badge-meeting {
        background-color: #0d6efd;
        color: #ffffff;
    }

    .badge-leave {
        background-color: #ffb100;
        color: #212529;
    }

    .badge-other {
        background-color: #6c757d;
        color: #ffffff;
    }

    @@media (max-width: 768px) {
        .calendar-day,
        .calendar-empty {
            height: 80px;
            padding: 0.25rem;
        }

        .day-number {
            font-size: 0.75rem;
        }

        .calendar-header-title {
            font-size: 1.1rem;
        }

        .table thead th {
            font-size: 0.7rem;
            padding: 0.25rem;
        }
    }
</style>

<div class="container py-4 calendar-wrapper">

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0 fw-bold">My Calendar</h3>

        <a asp-controller="calendar"
           asp-action="EmployeeCreateTodo"
           class="btn btn-primary btn-sm">
            + Add To-Do
        </a>
    </div>

    <div class="calendar-card p-3">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a asp-controller="calendar"
               asp-action="EmployeeCreateTodo"
               asp-route-month="@prevMonth"
               asp-route-year="@prevYear"
               class="btn btn-outline-secondary btn-sm">
                &laquo; Prev
            </a>

            <h4 class="calendar-header-title m-0">
                @firstDayOfMonth.ToString("MMMM").ToUpper() @year
            </h4>

            <a asp-controller="calendar"
               asp-action="UserCalendar"
               asp-route-month="@nextMonth"
               asp-route-year="@nextYear"
               class="btn btn-outline-secondary btn-sm">
                Next &raquo;
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered text-center align-middle mb-0"
                   style="table-layout: fixed; width: 100%;">
                <thead class="table-light">
                    <tr class="fw-bold text-uppercase small">
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int day = 1;

                        for (int row = 0; row < rows; row++)
                        {
                            <tr>
                                @for (int col = 0; col < 7; col++)
                                {
                                    int cellIndex = row * 7 + col;

                                    if (cellIndex < startOffset || day > daysInMonth)
                                    {
                                        <td class="calendar-empty"></td>
                                    }
                                    else
                                    {
                                        var date = new DateTime(year, month, day);
                                        bool isToday = date.Date == DateTime.Today.Date;
                                        bool isWeekend = date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;

                                        var tdClasses = "calendar-day";
                                        if (isWeekend) tdClasses += " calendar-weekend";
                                        if (isToday) tdClasses += " calendar-today";

                                        var eventsForDay = Model.Events
    // Show the event on every day between Start and End (inclusive)
    .Where(e => e.Start.Date <= date.Date && e.End.Date >= date.Date)
    .OrderBy(e => e.EventType)
    .ThenBy(e => e.Start)
    .ToList();

    


                                        var holidaysForDay = Model.Holidays
                                        .Where(h => h.HolidayDate.Date == date.Date)
                                        .ToList();

                                        <td class="@tdClasses">
                                            <!-- Click day to add to-do for that date -->
                                            <a asp-controller="calendar"
                                               asp-action="EmployeeCreateTodo"
                                               asp-route-date="@date.ToString("yyyy-MM-ddTHH:mm")"
                                               class="day-number text-decoration-none text-dark">
                                                @day
                                            </a>

                                            <div class="calendar-events">
                                                @foreach (var ev in eventsForDay)
                                                {
                                                    var badgeClass = "badge-other";

                                                    @if (ev.EventType == CalendarEventType.PublicHoliday)
    badgeClass = "badge-holiday";
else if (ev.EventType == CalendarEventType.Meeting)
    badgeClass = "badge-meeting";
else if (ev.EventType == CalendarEventType.AnnualLeave)
    badgeClass = "badge-leave";


                                                    var displayTitle = ev.IsTodo
                                                    ? $"To-Do: {ev.Title}"
                                                    : ev.Title;

                                                    if (ev.IsTodo)
                                                    {
                                                       <a asp-controller="calendar"
   asp-action="AdminEdit"
   asp-route-id="@ev.Id"
   class="badge calendar-event @badgeClass d-block mb-1 text-truncate text-decoration-none"
   title="@($"{ev.Title} | {ev.Start:HH\\:mm}-{ev.End:HH\\:mm}")">
    @ev.Title
</a>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge calendar-event d-block mb-1 text-truncate @badgeClass"
                                                              title="@($"{displayTitle} | {ev.Start:HH\\:mm}-{ev.End:HH\\:mm}")">
                                                            @displayTitle
                                                        </span>
                                                    }
                                                }

                                                @foreach (var h in holidaysForDay)
                                                {
                                                    <span class="badge calendar-event d-block mb-1 text-truncate badge-public"
                                                          title="@h.Name">
                                                        @h.Name
                                                    </span>
                                                }
                                            </div>
                                        </td>

                                        day++;
                                    }
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <h6 class="fw-semibold">Legend</h6>
        <div class="d-flex flex-wrap gap-2 small">
            <span class="badge badge-public">Public Holiday</span>
            <span class="badge badge-meeting">Meeting</span>
            <span class="badge badge-leave">Annual Leave</span>
            <span class="badge badge-other">Other / To-Do</span>
        </div>
    </div>
</div>



