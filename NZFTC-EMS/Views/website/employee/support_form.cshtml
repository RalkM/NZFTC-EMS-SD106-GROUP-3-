@{
    Layout = ViewData["Layout"]?.ToString();
    ViewData["Title"] = "Support";
}
<link rel="stylesheet" href="~/css/portal-StyleSheet.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

<div class="container py-4">
  <h3 class="fw-bold mb-3">Support</h3>

  <div class="card mb-4">
    <div class="card-header fw-semibold">New Ticket</div>
    <div class="card-body">
      <form id="create-form" class="row g-3">
        @Html.AntiForgeryToken()
        <div class="col-md-6">
          <label class="form-label">Subject</label>
          <input id="subject" class="form-control" maxlength="120" required />
        </div>
        <div class="col-md-3">
          <label class="form-label">Priority</label>
          <select id="priority" class="form-select">
            <option>Low</option><option selected>Medium</option><option>High</option><option>Urgent</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Message</label>
          <textarea id="message" class="form-control" rows="4" maxlength="4000" required></textarea>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header fw-semibold d-flex justify-content-between">
      <span>My Tickets</span>
      <button class="btn btn-sm btn-outline-secondary" id="btn-refresh">Refresh</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-light">
            <tr>
              <th style="width:6rem;">ID</th>
              <th>Subject</th>
              <th>Preview</th>
              <th style="width:8rem;">Status</th>
              <th style="width:8rem;">Priority</th>
              <th style="width:14rem;">Created</th>
              <th style="width:14rem;">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"><tr><td colspan="7" class="text-muted">Loading…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Thread modal -->
  <div class="modal fade" id="threadModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ticket #<span id="th-id"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="thread" class="vstack gap-2"></div>
          <form id="reply-form" class="mt-3">
            @Html.AntiForgeryToken()
            <div class="input-group">
              <input id="reply-body" class="form-control" placeholder="Type a reply…" maxlength="4000" required />
              <button class="btn btn-primary">Send</button>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btn-close-ticket" class="btn btn-outline-secondary">Close Ticket</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

function badge(cls, text){ return `<span class="badge ${cls}">${text}</span>` }
function statusBadge(s){
  const m = { Open:'text-bg-warning', InProgress:'text-bg-info', Resolved:'text-bg-success', Closed:'text-bg-secondary' };
  return badge(m[s]||'text-bg-light', s);
}
function priorityBadge(p){
  const m = { Low:'text-bg-secondary', Medium:'text-bg-primary', High:'text-bg-warning', Urgent:'text-bg-danger' };
  return badge(m[p]||'text-bg-light', p);
}

async function loadRows(){
  const res = await fetch('/support/api/list');
  const rows = await res.json();
  const tbody = document.getElementById('rows');
  if(!rows.length){ tbody.innerHTML = `<tr><td colspan="7" class="text-muted">No tickets yet.</td></tr>`; return; }
  tbody.innerHTML = rows.map(t => `
    <tr>
      <td class="text-center fw-semibold">${t.id}</td>
      <td class="fw-semibold">${t.subject}</td>
      <td>${t.preview}</td>
      <td class="text-center">${statusBadge(t.status)}</td>
      <td class="text-center">${priorityBadge(t.priority)}</td>
      <td class="text-nowrap">${new Date(t.createdAt).toLocaleString()}</td>
      <td class="text-center">
        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-sm btn-outline-primary" onclick="openThread(${t.id})">Open</button>
        </div>
      </td>
    </tr>
  `).join('');
}

async function openThread(id){
  document.getElementById('th-id').textContent = id;
  const res = await fetch(`/support/api/${id}/thread`);
  const msgs = await res.json();
  const box = document.getElementById('thread');
  box.innerHTML = msgs.map(m => `
    <div class="p-2 rounded ${m.i
