<<<<<<< Updated upstream
<<<<<<< Updated upstream
﻿@{
    ViewData["Title"] = "Portal";
    var role = Context.Session.GetString("Role");
    var fullName = Context.Session.GetString("FullName") ?? "Employee";
=======
=======
>>>>>>> Stashed changes
﻿@using NZFTC_EMS.Data.Entities
@using NZFTC_EMS.Models.ViewModels

@{
    ViewData["Title"] = "Portal";

    var role     = (string?)ViewBag.Role     ?? "Employee";
    var fullName = (string?)ViewBag.FullName ?? "User";
    var admin  = ViewBag.AdminVm    as AdminDashboardVm    ?? new AdminDashboardVm();
    var emp    = ViewBag.EmployeeVm as EmployeeDashboardVm ?? new EmployeeDashboardVm();
    var recent = ViewBag.RecentItems  as List<string>       ?? new List<string>();
    var upcoming = ViewBag.Upcoming  as List<string>       ?? new List<string>();
    var announcements = ViewBag.Announcements as List<Announcement> ?? new List<Announcement>();
var recentItems = ViewBag.RecentItems as List<string>?? new List<string>();
var upcomingItems = ViewBag.Upcoming as List<string>?? new List<string>();
var recentPayslips= ViewBag.RecentEmployeePayslips as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
var recentEmployeeTicket = ViewBag.RecentEmployeeTicket;
    var empVm = ViewBag.EmployeeVm as EmployeeDashboardVm;


    bool isAdmin = role.Equals("Admin", StringComparison.OrdinalIgnoreCase)
                || role.Equals("HR",    StringComparison.OrdinalIgnoreCase);

    int grievancesInProgress        = ViewBag.GrievancesInProgress        is int gip ? gip : 0;
    int grievancesClosedLast30    = ViewBag.GrievancesClosedLast30Days is int gr ? gr : 0;
    int employeeOpenTickets         = ViewBag.EmployeeOpenTicketsCount    is int eot ? eot : 0;
    var empPayslips     = ViewBag.EmpRecentPayslips as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var empUpcoming     = ViewBag.EmpUpcomingLeave  as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var empLeaveHistory = ViewBag.EmpLeaveHistory   as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    string empLatestTicketSummary = ViewBag.EmpLatestTicketSummary as string;
    string empLatestTicketUpdated = ViewBag.EmpLatestTicketUpdated as string;
<<<<<<< Updated upstream
>>>>>>> Stashed changes
=======
>>>>>>> Stashed changes
}

<div class="container mt-4">

    @if (role == "Admin")
    {
<<<<<<< Updated upstream
        <h2>Welcome, @fullName</h2>
       <h3>Dashboard here</h3>
    }
    else if (role == "Employee")
    {
        <h2>Welcome, @fullName</h2>
        <h3>Dashboard here</h3>
    }
    else
    {
        <div class="alert alert-danger mt-3">
            Role not recognized. Please log in again.
        </div>
    }
</div>
=======
        <section class="dashboard admin-dashboard">
                <div>
                    <h1>Welcome, @fullName</h1>
                    <p class="dash-subtitle">@DateTime.Today</p>
                </div>
                <div class="dash-user">
                    <div class="avatar-circle">@fullName.First()</div>
                    <div class="dash-user-meta">
                        <span class="dash-user-name">@fullName</span>
                        <span class="dash-user-role">Admin</span>
                    </div>
                </div>

            <!-- KPI STRIP -->

            <section class="dash-kpis">
                <article class="kpi-card">
                    <span class="kpi-label">Annual Salary</span>
                    <span class="kpi-value">@emp.AnnualSalary.ToString("N2")</span>
                    <span class="kpi-meta">Based on your latest pay rate</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">YTD Total Earnings</span>
                    <span class="kpi-value">@emp.YtdEarnings.ToString("N2")</span>
                    <span class="kpi-meta">Since the start of the tax year</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Annual Leave</span>
                    <span class="kpi-value">@emp.AnnualLeaveHours.ToString("0.0") days</span>
                    <span class="kpi-meta">Remaining balance</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Sick Leave</span>
                    <span class="kpi-value">@emp.SickLeaveHours.ToString("0.0") days</span>
                    <span class="kpi-meta">Remaining balance</span>
                </article>
            </section>            

            <section class="dash-kpis">
                <article class="kpi-card">
                    <span class="kpi-label">Total Employees</span>
                    <span class="kpi-value">@admin.TotalEmployees</span>
                    <span class="kpi-meta">Company-wide headcount</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Active Leave Today</span>
                    <span class="kpi-value">@admin.ActiveLeave</span>
                    <span class="kpi-meta">Employees currently on leave</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Pending Leave Requests</span>
                    <span class="kpi-value">@admin.PendingLeave</span>
                    <span class="kpi-meta">Awaiting approval</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Open Grievances</span>
                    <span class="kpi-value">@admin.OpenGrievances</span>
                    <span class="kpi-meta">Support tickets open / in progress</span>
                </article>
            </section>

            <!-- QUICK ACTIONS -->
            <section class="dash-quick-actions">
    <a asp-controller="employee_management" asp-action="Create" class="chip-btn">+ Add employee</a>
    <a asp-controller="LeaveManagement" asp-action="Index" class="chip-btn">View leave queue</a>
    <a asp-controller="payroll_management" asp-action="Index" class="chip-btn">Run payroll</a>
                <a asp-controller="LeaveManagement" asp-action="ApplyLeave" class="chip-btn">+ Apply for leave</a>
<a asp-controller="employee_payroll" asp-action="Payslips" class="chip-btn">View latest payslip</a>
<a asp-controller="portal" asp-action="Support" class="chip-btn">Submit support ticket</a>
            </section>




            <!-- MIDDLE BAND: 2 COLUMNS -->
            <section class="dash-grid dash-grid-2">
                <!-- People & Approvals -->
                <div class="dash-column">
                    <article class="dash-card">
                        <div class="dash-card-header">
                            <h2>Employee Summary</h2>
                            <div class="dash-actions">
                               <a asp-controller="employee_management" asp-action="Index" class="btn-secondary">View all</a>
                            </div>
                        </div>
                        <ul class="dash-list">
                            <li><strong>@admin.TotalEmployees</strong> employees in the system</li>
                            <li><strong>@admin.ActiveLeave</strong> currently on leave</li>
                            <li><strong>@admin.PendingLeave</strong> leave requests awaiting approval</li>
                        </ul>
                    </article>
                    <br />

                    <article class="dash-card">
                        <div class="dash-card-header">
                            <h2>Items Awaiting Your Review</h2>
                            <div class="dash-pill-group">
                                <a asp-controller="LeaveManagement" asp-action="Index" class="pill">Leave (@admin.PendingLeaveRequests)</a>
                                <a asp-controller="support_management" asp-action="Index" class="pill">Support (@admin.PendingSupportTickets)</a>
                            </div>
                        </div>

                        <div class="dash-table">
                            <div class="dash-table-row">
                                <span>Leave requests</span>
                                <span class="dash-tag warning">Pending: @admin.PendingLeaveRequests</span>
                                <span class="dash-table-meta">check Leave Management</span>
                            </div>

                            <div class="dash-table-row">
                                <span>Support tickets</span>
                                <span class="dash-tag info">Open: @admin.PendingSupportTickets</span>
                                <span class="dash-table-meta">check Support Tickets</span>
                            </div>
                        </div>
                    </article>
                    <br />
                </div>

                <!-- Payroll & Grievances -->
                <div class="dash-column">
                    <article class="dash-card">
                        <div class="dash-card-header">
                            <h2>Payroll Overview</h2>
                            <a asp-controller="payroll_management" asp-action="Index" class="btn-secondary">View payroll</a>
                        </div>
                        <div class="dash-mini-chart">
                            <div class="chart-placeholder">[ Sparkline – last 6 periods ]</div>
                            <div class="chart-meta">
                                <p><strong>Next run:</strong> @admin.NextPayrollRunLabel</p>
                                <p><strong>Latest totals:</strong> @admin.LatestTotalsLabel</p>
                            </div>
                        </div>
                    </article>
                    <br />

                    <article class="dash-card">
                        <div class="dash-card-header">
                            <h2>Grievances Overview</h2>
                            <a asp-controller="Support_Management" asp-action="Index" class="btn-secondary">View tickets</a>
                        </div>
                        <div class="dash-mini-chart dash-mini-chart--split">
                            <div class="chart-placeholder">[ Donut • Open / In progress / Resolved ]</div>
                            <ul class="dash-legend">
                                <li><span class="legend-dot dot-open"></span>Open / in progress: @admin.OpenGrievances</li>
                                <li><span class="legend-dot dot-progress"></span>In progress: @grievancesInProgress</li>
                                <li><span class="legend-dot dot-resolved"></span>Closed (30d): @grievancesClosedLast30</li>
                            </ul>
                        </div>
                        <p class="dash-note">
                            Use the Support Tickets page to follow up on open cases and close resolved grievances.
                        </p>
                    </article>
                    <br />
                </div>
            </section>
<section class="dash-grid dash-grid-3">
    <!-- Recent Activity -->
    <article class="dash-card">
        <div class="dash-card-header">
            <h2>Recent Activity</h2>
        </div>
        <ul class="timeline">
            @if (recent.Any())
            {
                foreach (var item in recent)
                {
                    <li>
                        <span class="timeline-dot"></span>
                        <div><p>@item</p></div>
                    </li>
                }
            }
            else
            {
                <li>
                    <span class="timeline-dot"></span>
                    <div><p>No recent HR or payroll activity.</p></div>
                </li>
            }
        </ul>
    </article>

    <!-- Upcoming Dates -->
    <article class="dash-card">
        <div class="dash-card-header">
            <h2>Upcoming Dates</h2>
        </div>
        <ul class="dash-list">
            @if (upcoming.Any())
            {
                foreach (var item in upcoming)
                {
                    <li>@item</li>
                }
            }
            else
            {
                <li>No upcoming events in the next 30 days.</li>
            }
        </ul>
    </article>

    <!-- Announcements -->
    <article class="dash-card">
        <div class="dash-card-header">
            <h2>Announcements</h2>
        </div>
        <ul class="dash-list">
            @if (announcements.Any())
            {
                foreach (var a in announcements)
                {
                    <li>
                        <strong>@a.Title</strong><br />
                        <span class="timeline-meta">
                            @a.CreatedAt.ToString("dd MMM yyyy")
                        </span><br />
                        @a.Body
                    </li>
                }
            }
            else
            {
                <li>No announcements yet.</li>
            }
        </ul>
    </article>
</section>


        </section>
    }

 @* ================= EMPLOYEE DASHBOARD ================= *@
    @if (!isAdmin)
    {
        <section class="dashboard employee-dashboard">
                <div>
                    <h1>Welcome, @fullName</h1>
                    <p class="dash-subtitle">Here’s a snapshot of your employment info</p>
                </div>        

            <section class="dash-kpis">
                <article class="kpi-card">
                    <span class="kpi-label">Annual Salary</span>
                    <span class="kpi-value">@emp.AnnualSalary.ToString("0.00")</span>
                    <span class="kpi-meta">Based on your latest pay rate</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">YTD Total Earnings</span>
                    <span class="kpi-value">@emp.YtdEarnings.ToString("0.00")</span>
                    <span class="kpi-meta">Since the start of the tax year</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Annual Leave</span>
                    <span class="kpi-value">@emp.AnnualLeaveHours.ToString("0.0") days</span>
                    <span class="kpi-meta">Remaining balance</span>
                </article>
                <article class="kpi-card">
                    <span class="kpi-label">Sick Leave</span>
                    <span class="kpi-value">@emp.SickLeaveHours.ToString("0.0") days</span>
                    <span class="kpi-meta">Remaining balance</span>
                </article>
            </section>

            <!-- QUICK ACTIONS -->
            <section class="dash-quick-actions">
                <a asp-controller="LeaveManagement" asp-action="ApplyLeave" class="chip-btn">+ Apply for leave</a>
                <a asp-controller="employee_payroll" asp-action="Payslips" class="chip-btn">View latest payslip</a>
                <a asp-controller="portal" asp-action="Support" class="chip-btn">Submit support ticket</a>
            </section>



            <!-- MIDDLE BAND -->
            <section class="dash-grid dash-grid-2">
                <div class="dash-column">
                    <article class="dash-card">
                        <div class="dash-card-header">
                            <h2>My Profile</h2>
                            <a asp-controller="employee_profile" asp-action="profile" class="btn-secondary">View full profile</a>
                        </div>
                        <div class="dash-card-body">
                            <div class="dash-avatar large">
                               <div class="avatar-circle">@fullName.First()</div>
                            </div>
                            <div class="dash-profile-info">
                                <h3>@emp.FullName</h3>
                                <p>
                                    Birthday: @(emp.Birthday == DateTime.MinValue
                                        ? "Not set"
                                        : emp.Birthday.ToString("dd MMM yyyy"))<br />
                                    Gender: @emp.Gender
                                </p>
                            </div>
                        </div>
                        <div class="dash-card-footer">
                            <a asp-controller="employee_profile" asp-action="Edit" class="btn-primary">Edit profile</a>
                        </div>
                    </article>
                </div>
<article class="dash-card">
<div class="dash-card-header">

<div class="dash-tabs">
<h2>Leave Overview</h2>

<div class="dash-tabs-nav">
    <button type="button" class="btn-secondary active" data-target="#emp-leave-upcoming">
        Upcoming
    </button>
    <button type="button" class="btn-secondary" data-target="#emp-leave-history">
        History
    </button>
</div>

        <div id="upcoming-tab" class="tab-pane active">
            @if (empVm != null && empVm.UpcomingLeave != null && empVm.UpcomingLeave.Any())
            {
                <ul class="list-unstyled mb-0">
                    @foreach (var l in empVm.UpcomingLeave)
                    {
                        <li class="mb-1">
                            <strong>@l.LeaveType</strong><br />
                            @l.StartDate.ToString("dd MMM yyyy") – @l.EndDate.ToString("dd MMM yyyy")
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>You have no upcoming approved leave.</p>
            }
        </div>

        <div id="emp-leave-history" class="dash-tab-pane">
    @if (empVm != null && empVm.PastLeave != null && empVm.PastLeave.Any())
    {
        <ul class="list-unstyled">
        @foreach (var l in empVm.PastLeave)
        {
            <li>
                @l.LeaveType – @l.StartDate.ToString("dd MMM yyyy") – @l.EndDate.ToString("dd MMM yyyy")
            </li>
        }
        </ul>
    }
    else
    {
        <p>No past leave records yet.</p>
    }
</div>

</div>
    </div>
</article>

            </section>

            <!-- BOTTOM BAND -->
            <section class="dash-grid dash-grid-2">
                <article class="dash-card">
                    <div class="dash-card-header">
                        <h2>Recent Payslips</h2>
                        <a asp-controller="employee_payroll" asp-action="Payslips" class="btn-secondary">View history</a>
                    </div>
                    <div class="dash-table">
                        <div class="dash-table-row">
                            <p>Your last 3 payslips will show here.</p>

@if (empPayslips.Any())
{
    <ul class="dash-list mt-2">
        @foreach (var p in empPayslips)
        {
            var period =
                p.PeriodStart != null && p.PeriodEnd != null
                    ? $"{((DateTime)p.PeriodStart):dd MMM}–{((DateTime)p.PeriodEnd):dd MMM}"
                    : ((DateTime)p.GeneratedAt).ToString("dd MMM yyyy");

            <li>
                <strong>@period</strong>
                <span class="d-block small">
                    Net pay: @(p.NetPay.ToString("0.00")) • generated @(p.GeneratedAt.ToString("dd MMM yyyy"))
                </span>
            </li>
        }
    </ul>
}
else
{
    <p class="text-muted small mt-2">No payslips have been generated for you yet.</p>
}
                        </div>
                    </div>
                </article>

                <article class="dash-card">
                    <div class="dash-card-header">
                        <h2>Support / Grievances</h2>
                        <a asp-controller="Support" asp-action="Index" class="btn-secondary">View all tickets</a>
                    </div>
                    <div class="dash-card-body">
                        <p>You have @employeeOpenTickets open support tickets.</p>

@if (!string.IsNullOrWhiteSpace(empLatestTicketSummary))
{
    <p class="mt-2">
        <strong>Latest ticket:</strong><br />
        @empLatestTicketSummary<br />
        <span class="small text-muted">Updated @empLatestTicketUpdated</span>
    </p>
}
else
{
    <p class="text-muted small mt-2">You haven’t submitted any support tickets yet.</p>
}
                    </div>
                </article>
            </section>

            <!-- INFO BAND -->
            <section class="dash-grid dash-grid-2">
                <!-- Upcoming Dates -->
<article class="dash-card">
    <div class="dash-card-header">
        <h2>Upcoming Dates</h2>
    </div>
    <ul class="dash-list">
        @if (upcoming.Any())
        {
            foreach (var item in upcoming)
            {
                <li>@item</li>
            }
        }
        else
        {
            <li>No upcoming events in the next 30 days.</li>
        }
    </ul>
</article>

                <!-- Announcements -->
<article class="dash-card">
    <div class="dash-card-header">
        <h2>Announcements</h2>
    </div>
    <ul class="dash-list">
        @if (announcements.Any())
        {
            foreach (var a in announcements)
            {
                <li>
                    <strong>@a.Title</strong><br />
                    <span class="timeline-meta">
                        @a.CreatedAt.ToString("dd MMM yyyy")
                    </span><br />
                    @a.Body
                </li>
            }
        }
        else
        {
            <li>No announcements yet.</li>
        }
    </ul>
</article>

            </section>
        </section>
    }

<<<<<<< Updated upstream
</main>
>>>>>>> Stashed changes
=======
</main>
>>>>>>> Stashed changes
